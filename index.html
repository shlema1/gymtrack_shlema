<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>GymTrack</title>
<style>
body { background:#121212; color:#eee; font-family:sans-serif; text-align:center }
button { padding:14px; margin:6px; font-weight:bold }
.big { font-size:4rem }
table { width:100%; margin-top:10px }
td { padding:6px; border-bottom:1px solid #333 }
</style>
</head>
<body>

<button onclick="connect()">CONNECT</button>
<div>Battery: <span id="bat">--</span>%</div>

<div class="big" id="reps">0</div>

<button onclick="cmd('START_SET')">START</button>
<button onclick="cmd('STOP_SET')">STOP</button>

<hr>

<button onclick="cmd('MODE_L')">LINEAR</button>
<button onclick="cmd('MODE_A')">AXIS</button>

<button onclick="cmd('AX_X')">X</button>
<button onclick="cmd('AX_Y')">Y</button>
<button onclick="cmd('AX_Z')">Z</button>

<hr>

<button onclick="cmd('CAL_MIN')">BOTTOM</button>
<button onclick="cmd('CAL_MAX')">TOP</button>

<hr>

<input id="code">
<button onclick="importCode()">IMPORT</button>

<table>
<thead><tr><td>#</td><td>Dist</td><td>Time</td></tr></thead>
<tbody id="log"></tbody>
</table>

<script>
const SVC = "4fafc201-1fb5-459e-8fcc-c5c9c331914b";
const CMD = "beb5483e-36e1-4688-b7f5-ea07361b26a8";
const STAT= "1c95d5e3-d8f7-413a-bf3d-7a2e5d7be87e";
const REP = "d4d4791e-0d1c-4772-9c71-2a67c55c7096";
const EX  = "70308365-5381-4209-9150-14966601f01c";

let cmdChar;

async function connect(){
  const dev = await navigator.bluetooth.requestDevice({filters:[{services:[SVC]}]});
  const gatt = await dev.gatt.connect();
  const svc = await gatt.getPrimaryService(SVC);

  cmdChar = await svc.getCharacteristic(CMD);

  (await svc.getCharacteristic(STAT))
    .startNotifications()
    .then(c=>c.addEventListener("characteristicvaluechanged",e=>{
      const t = new TextDecoder().decode(e.target.value);
      if (t.startsWith("BAT")) document.getElementById("bat").innerText = t.split("|")[1];
    }));

  (await svc.getCharacteristic(REP))
    .startNotifications()
    .then(c=>c.addEventListener("characteristicvaluechanged",e=>{
      const p = new TextDecoder().decode(e.target.value).split("|");
      document.getElementById("reps").innerText = p[1];
      document.getElementById("log").insertAdjacentHTML("afterbegin",
        `<tr><td>${p[1]}</td><td>${p[2]}</td><td>${p[3]}</td></tr>`
      );
    }));

  (await svc.getCharacteristic(EX))
    .startNotifications()
    .then(c=>c.addEventListener("characteristicvaluechanged",e=>{
      document.getElementById("code").value =
        new TextDecoder().decode(e.target.value);
    }));
}

function cmd(c){
  if(cmdChar) cmdChar.writeValue(new TextEncoder().encode(c));
}

function importCode(){
  cmd("IMPORT:" + document.getElementById("code").value);
}
</script>
</body>
</html>
