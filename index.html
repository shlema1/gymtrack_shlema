<!DOCTYPE html>
<html lang="cs">
<head>
<meta charset="UTF-8">
<title>GymTrack</title>
<style>
body{font-family:sans-serif;background:#111;color:#eee}
button,input{margin:4px;padding:8px;font-size:16px}
table{border-collapse:collapse;width:100%;margin-top:20px}
td,th{border:1px solid #444;padding:6px;text-align:center}
.ok{color:#0f0}.fail{color:#f33}
</style>
</head>
<body>

<h2>GymTrack</h2>

<button onclick="connect()">CONNECT</button>
<button onclick="cmd('MODE_ROT')">ROT</button>
<button onclick="cmd('MODE_LIN')">LIN</button>
<button onclick="cmd('CAL_MIN')">CAL MIN</button>
<button onclick="cmd('CAL_MAX')">CAL MAX</button>
<button onclick="cmd('START_SET')">START</button>
<button onclick="cmd('STOP_SET')">STOP</button>

<br><br>
<input id="code" placeholder="exercise code">
<button onclick="importCode()">IMPORT</button>
<div>EXPORT: <span id="export">---</span></div>

<p id="status">DISCONNECTED</p>

<table>
<tr><th>Rep</th><th>Status</th><th>Range%</th><th>Conc</th><th>Ecc</th></tr>
<tbody id="rows"></tbody>
</table>

<script>
let cmdChar,statusChar,repChar,exerciseChar;

async function connect(){
  const dev=await navigator.bluetooth.requestDevice({
    filters:[{name:'GymTrack'}],
    optionalServices:['1234']
  });
  const srv=await dev.gatt.connect();
  const svc=await srv.getPrimaryService('1234');

  cmdChar=await svc.getCharacteristic('1235');
  statusChar=await svc.getCharacteristic('1236');
  repChar=await svc.getCharacteristic('1237');
  exerciseChar=await svc.getCharacteristic('1238');

  await statusChar.startNotifications();
  await repChar.startNotifications();

  statusChar.oncharacteristicvaluechanged=e=>{
    const d=JSON.parse(new TextDecoder().decode(e.target.value));
    status.innerText=`Idle | Pos ${d.pos} | Batt ${d.battery}%`;
  };

  repChar.oncharacteristicvaluechanged=e=>{
    const d=JSON.parse(new TextDecoder().decode(e.target.value));
    rows.innerHTML+=`<tr>
      <td>${d.rep}</td>
      <td class="${d.valid?'ok':'fail'}">${d.valid?'OK':'FAIL'}</td>
      <td>${Math.round(d.range*100)}</td>
      <td>${d.valid?d.conc.toFixed(2):'-'}</td>
      <td>${d.valid?d.ecc.toFixed(2):'-'}</td>
    </tr>`;
  };

  export.innerText=new TextDecoder().decode(await exerciseChar.readValue());
  status.innerText="CONNECTED";
}

function cmd(c){ cmdChar.writeValue(new TextEncoder().encode(c)); }
function importCode(){ cmd("IMPORT:"+code.value); }
</script>
</body>
</html>
