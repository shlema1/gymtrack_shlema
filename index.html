<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gym Track v6.0</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background-color: #121212; color: #e0e0e0; display: flex; flex-direction: column; align-items: center; min-height: 100vh; margin: 0; padding: 20px; }
        h1 { margin-bottom: 10px; font-size: 1.5rem; color: #bb86fc; }
        .card { background-color: #1e1e1e; border-radius: 12px; padding: 20px; width: 100%; max-width: 350px; margin-bottom: 15px; box-shadow: 0 4px 6px rgba(0,0,0,0.3); text-align: center; }
        .btn { border: none; padding: 12px 20px; border-radius: 8px; font-weight: bold; cursor: pointer; width: 100%; margin: 5px 0; font-size: 1rem; transition: 0.2s; }
        .btn-primary { background-color: #bb86fc; color: #000; }
        .btn-success { background-color: #03dac6; color: #000; }
        .btn-danger { background-color: #cf6679; color: #000; }
        .btn-outline { background-color: transparent; border: 1px solid #bb86fc; color: #bb86fc; }
        .value-display { font-size: 2.5rem; font-weight: bold; margin: 10px 0; color: #ffffff; }
        .label { font-size: 0.8rem; color: #a0a0a0; text-transform: uppercase; letter-spacing: 1px; }
        .status-box { font-size: 0.9rem; color: #03dac6; margin-top: 5px; min-height: 1.2em; font-weight: bold; }
        .history-item { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #333; font-size: 0.9rem; }
        .valid { color: #03dac6; } .invalid { color: #cf6679; }
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .live-val { color: #ffeb3b; font-size: 1.2rem; margin-top: 5px; }
    </style>
</head>
<body>

    <h1>Gym Track v6.0</h1>
    <div id="status" style="color: grey; margin-bottom: 20px;">Disconnected</div>

    <div class="card" id="controlPanel" style="display:none;">
        <div class="label">Status Kalibrace</div>
        <div id="calibStatus" class="status-box">P≈ôipraveno</div>
        
        <hr style="border-color: #333;">
        
        <div class="label">≈Ωiv√° Poloha Senzoru</div>
        <div id="liveDrift" class="live-val">-- ¬∞</div>
        
        <div class="grid" style="margin-top: 15px;">
            <button class="btn btn-outline" onclick="sendCommand('C')">1. Start Pos</button>
            <button class="btn btn-outline" onclick="sendCommand('c')">2. End Pos</button>
        </div>
        <button class="btn btn-outline" onclick="sendCommand('T')">Tare (Vynulovat)</button>
    </div>

    <div class="card" id="sessionPanel" style="display:none;">
        <div class="label">Last Rep</div>
        <div class="value-display" id="lastRep">0%</div>
        <div class="label">Reps Completed</div>
        <div class="value-display" id="repCount">0</div>
        
        <div class="grid">
            <button class="btn btn-success" onclick="startSession()">Start Session</button>
            <button class="btn btn-danger" onclick="endSession()">Stop</button>
        </div>
    </div>

    <div class="card" id="historyPanel" style="display:none;">
        <div class="label">History</div>
        <div id="historyList"></div>
    </div>

    <button id="connectBtn" class="btn btn-primary" onclick="connect()">CONNECT</button>

    <script>
        const serviceUuid = "12345678-1234-1234-1234-123456789012";
        const charCmdUuid = "87654321-4321-4321-4321-210987654321";
        const charDataUuid = "abcdef01-1234-5678-1234-56789abcdef0";
        
        let device, cmdChar, dataChar;

        async function connect() {
            try {
                device = await navigator.bluetooth.requestDevice({
                    filters: [{ namePrefix: "Gym" }],
                    optionalServices: [serviceUuid]
                });
                const server = await device.gatt.connect();
                const service = await server.getPrimaryService(serviceUuid);
                cmdChar = await service.getCharacteristic(charCmdUuid);
                dataChar = await service.getCharacteristic(charDataUuid);

                await dataChar.startNotifications();
                dataChar.addEventListener('characteristicvaluechanged', handleData);

                document.getElementById('status').innerText = "Connected";
                document.getElementById('status').style.color = "#03dac6";
                document.getElementById('connectBtn').style.display = "none";
                document.getElementById('controlPanel').style.display = "block";
                document.getElementById('sessionPanel').style.display = "block";
                document.getElementById('historyPanel').style.display = "block";
            } catch (error) {
                console.log(error);
                alert("Connection Failed: " + error);
            }
        }

        function handleData(event) {
            const dec = new TextDecoder();
            const val = dec.decode(event.target.value);
            
            // --- LIVE DATA ---
            if (val.startsWith("LIVE:")) {
                // Form√°t LIVE:25.5
                let num = val.split(':')[1];
                document.getElementById('liveDrift').innerText = num + " ¬∞";
            }
            // --- STATUS MESSAGES ---
            else if (val.startsWith("STATUS:")) {
                let msg = val.split(':')[1];
                let statusBox = document.getElementById('calibStatus');
                
                if (msg === "START_SET") {
                    statusBox.innerText = "‚è≥ Mƒõ≈ô√≠m START... H√Ωbej do c√≠le!";
                    statusBox.style.color = "#ffeb3b"; // ≈Ωlut√°
                } else if (msg === "READY") {
                    statusBox.innerText = "‚úÖ Kalibrace OK. M≈Ø≈æe≈° cviƒçit.";
                    statusBox.style.color = "#03dac6"; // Zelen√°
                } else if (msg === "LOADED") {
                    statusBox.innerText = "üìÇ Profil naƒçten.";
                }
            }
            // --- REP DATA ---
            else if (val.includes(":")) { // Rep data
                // "1: 100% | 1.2s / 1.0s"
                let parts = val.split(':');
                let repNum = parts[0];
                let details = parts[1].split('|');
                let pct = details[0];
                
                document.getElementById('repCount').innerText = repNum;
                document.getElementById('lastRep').innerText = pct;
                
                // P≈ôidat do historie
                let div = document.createElement('div');
                div.className = 'history-item valid';
                div.innerText = `#${repNum} - ${pct} ${details[1]}`;
                document.getElementById('historyList').prepend(div);
            }
        }

        async function sendCommand(cmd) {
            if (!cmdChar) return;
            await cmdChar.writeValue(new TextEncoder().encode(cmd));
        }

        function startSession() { sendCommand('S'); document.getElementById('historyList').innerHTML = ''; }
        function endSession() { sendCommand('E'); }
    </script>
</body>
</html>
