<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>GymTrack</title>
<style>
body{background:#111;color:#eee;font-family:sans-serif}
.card{background:#1c1c1c;padding:15px;border-radius:12px;margin:10px}
button{padding:10px;width:100%;margin:5px;font-weight:bold}
canvas{width:100%;height:200px}
table{width:100%;font-size:12px}
</style>
</head>
<body>

<div class="card">
  <button onclick="connect()">CONNECT</button>
  ðŸ”‹ <span id="bat">--</span>%
</div>

<div class="card">
  <button onclick="cmd('START_SET')">START SET</button>
  <button onclick="cmd('STOP_SET')">STOP SET</button>
</div>

<div class="card">
  <input id="codeIn">
  <button onclick="importCode()">IMPORT</button>
</div>

<div class="card">
  <canvas id="g"></canvas>
</div>

<div class="card">
<table>
<thead><tr><th>Set</th><th>Rep</th><th>cm</th><th>conf</th></tr></thead>
<tbody id="log"></tbody>
</table>
</div>

<script>
const S="4fafc201-1fb5-459e-8fcc-c5c9c331914b";
const C_CMD="beb5483e-36e1-4688-b7f5-ea07361b26a8";
const C_STAT="1c95d5e3-d8f7-413a-bf3d-7a2e5d7be87e";
const C_REP="d4d4791e-0d1c-4772-9c71-2a67c55c7096";

let cmdChar;
let ctx=document.getElementById("g").getContext("2d");
let x=0;

async function connect(){
  const d=await navigator.bluetooth.requestDevice({filters:[{services:[S]}]});
  const s=await d.gatt.connect();
  const svc=await s.getPrimaryService(S);
  cmdChar=await svc.getCharacteristic(C_CMD);

  (await svc.getCharacteristic(C_STAT)).startNotifications()
    .then(c=>c.addEventListener("characteristicvaluechanged",e=>{
      let j=JSON.parse(new TextDecoder().decode(e.target.value));
      document.getElementById("bat").innerText=j.bat;
      document.getElementById("codeIn").value=j.code;
    }));

  (await svc.getCharacteristic(C_REP)).startNotifications()
    .then(c=>c.addEventListener("characteristicvaluechanged",onRep));
}

function onRep(e){
  let d=JSON.parse(new TextDecoder().decode(e.target.value));
  document.getElementById("log").insertAdjacentHTML("afterbegin",
    `<tr><td>${d.set}</td><td>${d.rep}</td><td>${d.dist}</td><td>${d.conf}</td></tr>`);

  ctx.fillStyle="#0f0";
  ctx.fillRect(x,200-d.dist,3,3);
  x+=3;
}

function cmd(c){cmdChar.writeValue(new TextEncoder().encode(c))}
function importCode(){cmd("IMPORT:"+codeIn.value)}
</script>
</body>
</html>
