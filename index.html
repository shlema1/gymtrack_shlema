<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>GymTrack Final</title>
    <style>
        :root { 
            --bg: #0a0a0a; 
            --card: #161616; 
            --primary: #00E676; 
            --accent: #2979ff;
            --danger: #ff4444;
            --text: #e0e0e0;
            --text-dim: #888;
        }
        
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 15px; text-align: center; }
        .grid { display: grid; gap: 15px; max-width: 500px; margin: auto; }
        .card { background: var(--card); padding: 20px; border-radius: 16px; border: 1px solid #222; }
        
        /* Header */
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .status-dot { height: 10px; width: 10px; background: #555; border-radius: 50%; display: inline-block; margin-right: 5px; }
        .status-dot.connected { background: var(--primary); box-shadow: 0 0 8px var(--primary); }

        /* Big Stats */
        .big-stat { font-size: 5rem; font-weight: 800; color: var(--primary); line-height: 1; margin: 10px 0; }
        .sub-stat { font-size: 1.5rem; color: #fff; font-weight: bold; }
        .label { font-size: 0.8rem; color: var(--text-dim); text-transform: uppercase; letter-spacing: 1px; }

        /* Progress Bar */
        .progress-bg { width: 100%; height: 8px; background: #333; border-radius: 4px; overflow: hidden; margin-top: 15px; }
        .progress-fill { height: 100%; background: var(--accent); width: 0%; transition: width 0.1s linear; }

        /* Buttons */
        button { width: 100%; padding: 16px; border: none; border-radius: 10px; font-weight: 700; font-size: 1rem; cursor: pointer; color: #fff; transition: 0.2s; margin-bottom: 8px; }
        button:active { transform: scale(0.98); }
        .btn-connect { background: var(--accent); }
        .btn-start { background: var(--primary); color: #000; }
        .btn-stop { background: var(--danger); }
        .btn-cal { background: #333; border: 1px solid #444; }
        .btn-cal.recording { background: #ff9800; color: #000; animation: pulse 1.5s infinite; }
        
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.7; } 100% { opacity: 1; } }

        /* Input Group */
        .input-group { display: flex; gap: 10px; margin-top: 10px; }
        input { flex: 1; background: #222; border: 1px solid #444; color: #fff; padding: 12px; border-radius: 8px; font-family: monospace; text-align: center; }

        /* Table */
        table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 0.9rem; }
        th { text-align: left; color: var(--text-dim); border-bottom: 1px solid #333; padding: 8px; }
        td { padding: 8px; border-bottom: 1px solid #222; }
        .val-ok { color: var(--primary); }
        .val-bad { color: var(--danger); }
    </style>
</head>
<body>

<div class="grid">

    <div class="card">
        <div class="header">
            <div style="font-weight:900; letter-spacing:1px">GYMTRACK</div>
            <div>
                <span class="status-dot" id="dot"></span>
                <span id="batVal">--</span>% üîã
            </div>
        </div>
        <button class="btn-connect" id="btnConnect" onclick="connect()">P≈òIPOJIT ZA≈ò√çZEN√ç</button>
    </div>

    <div id="dashboard" style="display:none;">
        
        <div class="card">
            <div style="display: flex; justify-content: space-between;">
                <div>
                    <div class="label">OPAKOV√ÅN√ç</div>
                    <div class="big-stat" id="repVal">0</div>
                </div>
                <div style="text-align: right;">
                    <div class="label">POLOHA</div>
                    <div class="sub-stat" id="posVal">0%</div>
                </div>
            </div>
            <div class="progress-bg">
                <div class="progress-fill" id="progressBar"></div>
            </div>
        </div>

        <div class="card">
            <div class="label" style="margin-bottom:10px">S√âRIE</div>
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                <button class="btn-start" onclick="cmd('START_SET')">‚ñ∂ START</button>
                <button class="btn-stop" onclick="cmd('STOP_SET')">‚èπ STOP</button>
            </div>
        </div>

        <div class="card">
            <div class="label" style="margin-bottom:10px">NASTAVEN√ç A KALIBRACE</div>
            
            <button id="btnCal" class="btn-cal" onclick="toggleCal()">üìè ZMƒö≈òIT ROZSAH (START)</button>
            
            <div style="margin-top: 15px;">
                <div class="label">K√ìD CVIKU (Import/Export)</div>
                <div class="input-group">
                    <input id="codeInput" placeholder="Nap≈ô. LZ:10-90">
                    <button style="width: auto; margin: 0;" class="btn-cal" onclick="importCode()">NAHR√ÅT</button>
                </div>
            </div>
        </div>

        <div class="card">
            <div class="label">HISTORIE S√âRIE</div>
            <table>
                <thead>
                    <tr>
                        <th>#</th>
                        <th>Rozsah</th>
                        <th>Dist</th>
                        <th>ƒåas (Con/Ecc)</th>
                    </tr>
                </thead>
                <tbody id="logBody"></tbody>
            </table>
        </div>

    </div>
</div>

<script>
const SERVICE_UUID = "4fafc201-1fb5-459e-8fcc-c5c9c331914b";
const CHAR_CMD     = "beb5483e-36e1-4688-b7f5-ea07361b26a8";
const CHAR_STATUS  = "1c95d5e3-d8f7-413a-bf3d-7a2e5d7be87e";
const CHAR_REP     = "d4d4791e-0d1c-4772-9c71-2a67c55c7096";
const CHAR_EX      = "70308365-5381-4209-9150-14966601f01c";

let device, cmdChar;
let isCalibrating = false;

async function connect() {
    try {
        device = await navigator.bluetooth.requestDevice({
            filters: [{ services: [SERVICE_UUID] }]
        });
        
        const server = await device.gatt.connect();
        const service = await server.getPrimaryService(SERVICE_UUID);
        
        cmdChar = await service.getCharacteristic(CHAR_CMD);

        // 1. Status (Baterie, Poloha)
        const stChar = await service.getCharacteristic(CHAR_STATUS);
        await stChar.startNotifications();
        stChar.addEventListener('characteristicvaluechanged', handleStatus);

        // 2. Reps (Opakov√°n√≠)
        const repChar = await service.getCharacteristic(CHAR_REP);
        await repChar.startNotifications();
        repChar.addEventListener('characteristicvaluechanged', handleRep);

        // 3. Exercise Code (Import/Export notifikace)
        const exChar = await service.getCharacteristic(CHAR_EX);
        await exChar.startNotifications();
        exChar.addEventListener('characteristicvaluechanged', (e) => {
            const code = new TextDecoder().decode(e.target.value);
            document.getElementById('codeInput').value = code;
            flashInput();
        });

        // UI Update
        document.getElementById('btnConnect').style.display = 'none';
        document.getElementById('dashboard').style.display = 'block';
        document.getElementById('dot').classList.add('connected');
        
        device.addEventListener('gattserverdisconnected', onDisconnect);

    } catch (e) {
        alert("Chyba p≈ôipojen√≠: " + e);
    }
}

function handleStatus(e) {
    const json = new TextDecoder().decode(e.target.value);
    const d = JSON.parse(json); // {"pos":0.5, "bat":80}
    
    // Baterie
    document.getElementById('batVal').innerText = d.bat;
    
    // Poloha (0.0 - 1.2) -> Procenta
    const pct = Math.round(d.pos * 100);
    document.getElementById('posVal').innerText = pct + "%";
    
    // Progress Bar (omezeno 0-100 pro grafiku)
    const barW = Math.max(0, Math.min(100, pct));
    document.getElementById('progressBar').style.width = barW + "%";
}

function handleRep(e) {
    const json = new TextDecoder().decode(e.target.value);
    const d = JSON.parse(json);
    // {"rep":1,"valid":true,"range":0.9,"dist":45.2,"conc":1.2,"ecc":0.8}

    document.getElementById('repVal').innerText = d.rep;

    const row = `<tr>
        <td>${d.rep}</td>
        <td class="${d.valid ? 'val-ok' : 'val-bad'}">${Math.round(d.range*100)}%</td>
        <td>${d.dist.toFixed(1)} cm</td>
        <td>${d.conc.toFixed(1)}s / ${d.ecc.toFixed(1)}s</td>
    </tr>`;
    
    document.getElementById('logBody').insertAdjacentHTML('afterbegin', row);
}

// Logika Kalibraƒçn√≠ho tlaƒç√≠tka
async function toggleCal() {
    const btn = document.getElementById('btnCal');
    if (!isCalibrating) {
        // Start
        await cmd('CAL_AUTO_START');
        btn.innerText = "üõë UKONƒåIT A ULO≈ΩIT";
        btn.classList.add('recording');
        isCalibrating = true;
    } else {
        // Stop
        await cmd('CAL_AUTO_STOP');
        btn.innerText = "üìè ZMƒö≈òIT ROZSAH (START)";
        btn.classList.remove('recording');
        isCalibrating = false;
    }
}

async function importCode() {
    const c = document.getElementById('codeInput').value;
    if(c) await cmd("IMPORT:" + c);
}

async function cmd(c) {
    if (cmdChar) await cmdChar.writeValue(new TextEncoder().encode(c));
}

function onDisconnect() {
    document.getElementById('dashboard').style.display = 'none';
    document.getElementById('btnConnect').style.display = 'block';
    document.getElementById('dot').classList.remove('connected');
    alert("Za≈ô√≠zen√≠ odpojeno");
}

function flashInput() {
    const el = document.getElementById('codeInput');
    el.style.borderColor = "#00E676";
    setTimeout(() => el.style.borderColor = "#444", 1000);
}
</script>

</body>
</html>
