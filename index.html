<!DOCTYPE html>
<html lang="cs">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>GymTrack BLE</title>
<style>
body{font-family:sans-serif;background:#111;color:#eee;text-align:center;padding:20px;}
button{margin:10px;padding:15px 30px;font-size:18px;cursor:pointer;background:#333;color:white;border:1px solid #555;border-radius:5px;}
button:active{background:#555;}
#status{font-weight:bold;color:#f90;margin:20px;}
.val{font-size:2em;font-family:monospace;color:#0f0;}
</style>
</head>
<body>

<h2>GymTrack BLE Control</h2>

<button id="btnConnect" onclick="connect()">游댋 P콎IPOJIT</button>
<br>
<button onclick="cmd('TARE')">丘뒲잺 TARE</button>

<p id="status">Odpojeno</p>
<div class="val" id="angleVal">--춿</div>

<script>
// Stejn치 UUID jako ve Firmware
const SERVICE_UUID = "4fafc201-1fb5-459e-8fcc-c5c9c331914b";
const CHAR_CMD     = "beb5483e-36e1-4688-b7f5-ea07361b26a8";
const CHAR_STATUS  = "1c95d5e3-d8f7-413a-bf3d-7a2e5d7be87e";

let device, cmdChar;

async function connect() {
  try {
    document.getElementById('status').innerText = "Hled치m za콏칤zen칤...";
    
    // ZM캨NA: Hled치me podle Services, ne podle jm칠na. To je spolehliv캩j코칤.
    device = await navigator.bluetooth.requestDevice({
      filters: [{ services: [SERVICE_UUID] }] 
    });

    const server = await device.gatt.connect();
    const service = await server.getPrimaryService(SERVICE_UUID);
    
    cmdChar = await service.getCharacteristic(CHAR_CMD);
    const statusChar = await service.getCharacteristic(CHAR_STATUS);

    // Zapnout notifikace
    await statusChar.startNotifications();
    statusChar.addEventListener('characteristicvaluechanged', handleStatus);

    document.getElementById('status').innerText = "P콎IPOJENO!";
    document.getElementById('status').style.color = "#0f0";
    document.getElementById('btnConnect').style.display = 'none';

    device.addEventListener('gattserverdisconnected', () => {
       document.getElementById('status').innerText = "Odpojeno";
       document.getElementById('status').style.color = "#f33";
       document.getElementById('btnConnect').style.display = 'inline-block';
    });

  } catch (error) {
    console.error(error);
    document.getElementById('status').innerText = "Chyba: " + error;
  }
}

function handleStatus(event) {
  const value = new TextDecoder().decode(event.target.value);
  try {
    const json = JSON.parse(value);
    document.getElementById('angleVal').innerText = json.angle.toFixed(1) + "춿";
  } catch(e) { console.log("JSON Error", value); }
}

async function cmd(c) {
  if (!cmdChar) return;
  try {
    await cmdChar.writeValue(new TextEncoder().encode(c));
    console.log("Sent:", c);
  } catch (e) { console.error(e); }
}
</script>
</body>
</html>
