<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<title>GymTrack</title>
<style>
body{background:#111;color:#eee;font-family:sans-serif;text-align:center}
button{padding:14px;margin:6px;width:100%;font-weight:bold}
.card{background:#1e1e1e;padding:16px;border-radius:12px;margin:10px}
.big{font-size:4rem;color:#00e676}
</style>
</head>
<body>

<div class="card">
  <b>GymTrack</b> ðŸ”‹ <span id="bat">--</span>%
  <button onclick="connect()">CONNECT</button>
</div>

<div id="ui" style="display:none">
  <div class="card"><div class="big" id="rep">0</div>REPS</div>

  <div class="card">
    <button onclick="cmd('START_SET')">START SET</button>
    <button onclick="cmd('STOP_SET')">STOP SET</button>
  </div>

  <div class="card">
    <button onclick="cmd('CAL_AUTO_START')">AUTO CAL START</button>
    <button onclick="cmd('CAL_AUTO_STOP')">AUTO CAL STOP</button>
  </div>

  <div class="card">
    <input id="code" placeholder="LZ:12-84">
    <button onclick="cmd('IMPORT:'+code.value)">IMPORT</button>
  </div>

  <table width="100%" id="log"></table>
</div>

<script>
const S="4fafc201-1fb5-459e-8fcc-c5c9c331914b";
const C={cmd:"beb5483e-36e1-4688-b7f5-ea07361b26a8",
stat:"1c95d5e3-d8f7-413a-bf3d-7a2e5d7be87e",
rep:"d4d4791e-0d1c-4772-9c71-2a67c55c7096",
ex:"70308365-5381-4209-9150-14966601f01c"};
let cmdChar;

async function connect(){
 const d=await navigator.bluetooth.requestDevice({filters:[{services:[S]}]});
 const g=await d.gatt.connect();
 const s=await g.getPrimaryService(S);
 cmdChar=await s.getCharacteristic(C.cmd);

 (await s.getCharacteristic(C.stat)).startNotifications()
  .then(c=>c.oncharacteristicvaluechanged=e=>{
    const j=JSON.parse(new TextDecoder().decode(e.target.value));
    bat.innerText=j.bat;
  });

 (await s.getCharacteristic(C.rep)).startNotifications()
  .then(c=>c.oncharacteristicvaluechanged=e=>{
    const j=JSON.parse(new TextDecoder().decode(e.target.value));
    rep.innerText=j.rep;
    log.innerHTML=`<tr><td>${j.rep}</td><td>${(j.dist||0).toFixed(1)}cm</td></tr>`+log.innerHTML;
  });

 (await s.getCharacteristic(C.ex)).startNotifications()
  .then(c=>c.oncharacteristicvaluechanged=e=>{
    code.value=new TextDecoder().decode(e.target.value);
  });

 ui.style.display="block";
}

function cmd(c){cmdChar.writeValue(new TextEncoder().encode(c))}
</script>
</body>
</html>
