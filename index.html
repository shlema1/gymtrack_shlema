<!DOCTYPE html>
<html lang="cs">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>GymTrack Ultimate</title>
<style>
    :root { --primary: #00E676; --bg: #121212; --card: #1e1e1e; --text: #eee; }
    body { font-family: sans-serif; background: var(--bg); color: var(--text); padding: 10px; margin: 0; text-align: center; }
    
    /* Grid Layout */
    .grid { display: grid; gap: 10px; max-width: 600px; margin: auto; }
    
    /* Cards */
    .card { background: var(--card); padding: 15px; border-radius: 12px; }
    h2 { margin: 0 0 10px 0; font-size: 1rem; color: #888; text-transform: uppercase; }
    
    /* Buttons */
    button { width: 100%; padding: 12px; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; margin-bottom: 5px; color: #fff; background: #333; }
    button.connect { background: #2979ff; }
    button.start { background: var(--primary); color: #000; }
    button.stop { background: #f44336; }
    button.cal { background: #ff9800; color: #000; }
    
    /* Stats */
    .big-val { font-size: 3rem; font-weight: bold; color: var(--primary); }
    .row { display: flex; justify-content: space-between; align-items: center; }
    
    /* Table */
    table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 0.85rem; }
    td, th { padding: 6px; border-bottom: 1px solid #333; text-align: center; }
    .ok { color: var(--primary); } .fail { color: #f44336; }
    
    input { width: 70%; padding: 10px; border-radius: 5px; border: 1px solid #444; background: #222; color: #fff; }
</style>
</head>
<body>

<div class="grid">
    <div class="card row">
        <div style="font-weight:bold">GYMTRACK</div>
        <div id="status">Odpojeno</div>
    </div>
    
    <button class="connect" id="btnConnect" onclick="connect()">PŘIPOJIT</button>

    <div class="card" id="mainPanel" style="display:none">
        <div class="row">
            <div>
                <h2>Opakování</h2>
                <div class="big-val" id="repVal">0</div>
            </div>
            <div>
                <h2>Poloha</h2>
                <div class="big-val" id="posVal">0%</div>
            </div>
        </div>
        
        <div style="margin-top:15px; display:grid; grid-template-columns:1fr 1fr; gap:10px;">
            <button class="start" onclick="cmd('START_SET')">START</button>
            <button class="stop" onclick="cmd('STOP_SET')">STOP</button>
        </div>
    </div>

    <div class="card" id="calPanel" style="display:none">
        <h2>Nastavení Cviku</h2>
        
        <div style="margin-bottom:10px">
            <button onclick="cmd('MODE_ROT')">MÓD: ROTACE (Biceps...)</button>
            <button onclick="cmd('MODE_LIN')">MÓD: LINEÁRNÍ (Bench...)</button>
        </div>
        
        <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px;">
            <button class="cal" onclick="cmd('CAL_MIN')">1. DOLNÍ BOD</button>
            <button class="cal" onclick="cmd('CAL_MAX')">2. HORNÍ BOD</button>
        </div>
        
        <div style="margin-top:15px; border-top:1px solid #333; padding-top:10px;">
            <input id="codeIn" placeholder="Vlož kód cviku...">
            <button style="width:25%" onclick="importCode()">IMPORT</button>
            <div style="margin-top:5px; font-size:0.8rem; color:#888;">
                EXPORT KÓD: <span id="exportCode" style="color:#fff; font-family:monospace">---</span>
            </div>
        </div>
    </div>

    <div class="card" id="logPanel" style="display:none">
        <h2>Historie Série</h2>
        <table>
            <thead><tr><th>#</th><th>Stav</th><th>Rozsah</th><th>Tempo (Con/Ecc)</th></tr></thead>
            <tbody id="logBody"></tbody>
        </table>
    </div>
</div>

<script>
const SERVICE = "4fafc201-1fb5-459e-8fcc-c5c9c331914b";
const CHAR_CMD = "beb5483e-36e1-4688-b7f5-ea07361b26a8";
const CHAR_STATUS = "1c95d5e3-d8f7-413a-bf3d-7a2e5d7be87e";
const CHAR_REP = "d4d4791e-0d1c-4772-9c71-2a67c55c7096";
const CHAR_EX = "70308365-5381-4209-9150-14966601f01c";

let cmdChar, exChar;

async function connect(){
    try {
        const dev = await navigator.bluetooth.requestDevice({filters:[{services:[SERVICE]}]});
        const srv = await dev.gatt.connect();
        const svc = await srv.getPrimaryService(SERVICE);
        
        cmdChar = await svc.getCharacteristic(CHAR_CMD);
        exChar = await svc.getCharacteristic(CHAR_EX);
        
        const stChar = await svc.getCharacteristic(CHAR_STATUS);
        await stChar.startNotifications();
        stChar.addEventListener('characteristicvaluechanged', handleStatus);

        const repChar = await svc.getCharacteristic(CHAR_REP);
        await repChar.startNotifications();
        repChar.addEventListener('characteristicvaluechanged', handleRep);

        document.getElementById('btnConnect').style.display='none';
        document.getElementById('mainPanel').style.display='block';
        document.getElementById('calPanel').style.display='block';
        document.getElementById('logPanel').style.display='block';
        document.getElementById('status').innerText = "Připojeno";
        document.getElementById('status').style.color = "#0f0";

    } catch(e) { alert(e); }
}

function handleStatus(e){
    const d = JSON.parse(new TextDecoder().decode(e.target.value));
    // {"pos":0.5, "raw":120, "bat":80}
    document.getElementById('posVal').innerText = Math.round(d.pos*100) + "%";
}

async function handleRep(e){
    const d = JSON.parse(new TextDecoder().decode(e.target.value));
    // {"rep":1,"valid":true,"range":0.9,"conc":1.2,"ecc":2.0}
    
    document.getElementById('repVal').innerText = d.rep;
    
    const row = `<tr>
        <td>${d.rep}</td>
        <td class="${d.valid?'ok':'fail'}">${d.valid?'OK':'FAIL'}</td>
        <td>${Math.round(d.range*100)}%</td>
        <td>${d.conc.toFixed(1)}s / ${d.ecc.toFixed(1)}s</td>
    </tr>`;
    document.getElementById('logBody').insertAdjacentHTML('afterbegin', row);

    // Po každém repu aktualizovat export kód
    const code = new TextDecoder().decode(await exChar.readValue());
    document.getElementById('exportCode').innerText = code;
}

function cmd(c){ if(cmdChar) cmdChar.writeValue(new TextEncoder().encode(c)); }
function importCode(){ cmd("IMPORT:"+document.getElementById('codeIn').value); }
</script>

</body>
</html>
