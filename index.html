<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gym Track</title>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background: #121212; color: #fff; text-align: center; padding: 20px; max-width: 600px; margin: auto; }
        h1 { color: #03dac6; margin-bottom: 5px; letter-spacing: 1px; }
        .box { background: #1e1e1e; border-radius: 12px; padding: 15px; margin-bottom: 15px; border: 1px solid #333; position: relative; }
        
        button { width: 100%; padding: 14px; margin: 6px 0; border: none; border-radius: 8px; font-size: 15px; font-weight: bold; cursor: pointer; color: white; transition: 0.2s; }
        button:active { transform: scale(0.98); }
        .btn-blue { background: #2196F3; } 
        .btn-green { background: #00C853; } 
        .btn-red { background: #D32F2F; } 
        .btn-purple { background: #6200EE; }
        .btn-gray { background: #424242; color: #aaa; font-size: 12px; padding: 8px; width: auto; margin-top: 10px;}
        /* Reboot button style */
        .btn-danger-zone { background: #220000; color: #d32f2f; border: 1px solid #440000; font-size: 11px; padding: 10px; margin-top: 30px; }

        input { width: 80%; padding: 12px; border-radius: 6px; border: 1px solid #444; background: #2c2c2c; color: #fff; text-align: center; font-size: 18px; letter-spacing: 2px; font-family: monospace; }
        
        #status { font-weight: bold; color: #777; margin-bottom: 20px; font-size: 14px; }
        #liveData { font-size: 56px; font-weight: bold; color: #03dac6; margin: 15px 0; }
        #batVal { position: absolute; top: 15px; right: 15px; color: #ffeb3b; font-size: 14px; font-weight: bold; }
        
        table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 14px; }
        td, th { border-bottom: 1px solid #333; padding: 10px; text-align: left; }
        th { color: #888; }
        .valid { color: #00C853; font-weight: bold; } 
        .invalid { color: #D32F2F; }

        .row { display: flex; gap: 10px; }
        .half { width: 50%; }
        hr { border: 0; border-top: 1px solid #333; margin: 15px 0; }
        .label { font-size: 12px; color: #aaa; margin-bottom: 5px; display: block; text-align: left; }
    </style>
</head>
<body>

    <h1>GYM TRACK</h1>
    <div id="status">Disconnected</div>
    
    <div class="box" id="connectBox">
        <button onclick="connectBLE()" class="btn-blue">CONNECT DEVICE</button>
    </div>

    <div id="mainPanel" style="display:none;">
        
        <div class="box">
            <div id="batVal">--%</div>
            <div style="font-size:12px; color:#aaa; margin-top:10px;">CURRENT SESSION</div>
            <div id="liveData">0</div>
            <div style="font-size:14px; color:#aaa; margin-bottom:15px;">REPS</div>
            
            <div class="row">
                <button onclick="send('S')" class="btn-green half">‚ñ∂ START</button>
                <button onclick="send('E')" class="btn-red half">‚èπ FINISH</button>
            </div>
        </div>

        <div class="box">
            <h3>Calibration & Setup</h3>
            
            <span class="label">Exercise Code (Load or Create):</span>
            <input type="text" id="codeIn" placeholder="Axxxx / Lxxxx">
            <button onclick="loadCode()" class="btn-purple">LOAD CODE</button>
            
            <hr>
            <span class="label">Create New Code (Calibrate):</span>
            
            <div style="margin-bottom:10px;">
                <span class="label" style="display:inline;">Angle Mode (Machines/Lever):</span>
                <div class="row">
                    <button onclick="send('C')" class="half" style="background:#333">1. Start (Bottom)</button>
                    <button onclick="send('c')" class="half" style="background:#333">2. Stop (Top)</button>
                </div>
            </div>

            <div>
                <span class="label" style="display:inline;">Linear Mode (Cable/Stack):</span>
                <div class="row">
                    <button onclick="send('P')" class="half" style="background:#333">1. Start (Bottom)</button>
                    <button onclick="send('p')" class="half" style="background:#333">2. Stop (Top)</button>
                </div>
            </div>
            
            <p style="font-size:11px; color:#666; margin-top:5px;">
                Code will appear in the box above after clicking "Stop".
            </p>

            <button onclick="testSensor()" class="btn-gray">üõ† Test Sensor</button>
        </div>

        <div class="box">
            <h3>Session History</h3>
            <table id="historyTable">
                <thead><tr><th>#</th><th>Range</th><th>Status</th></tr></thead>
                <tbody id="histBody"></tbody>
            </table>
        </div>

        <button onclick="rebootDevice()" class="btn-danger-zone">‚ö†Ô∏è REBOOT DEVICE SYSTEM</button>
        <div style="height: 30px;"></div>
    </div>

    <script>
        const sUUID = "12345678-1234-1234-1234-123456789012";
        const cCmd = "87654321-4321-4321-4321-210987654321";
        const cData = "abcdef01-1234-5678-1234-56789abcdef0";
        let dev, srv, chCmd;

        async function connectBLE() {
            try {
                dev = await navigator.bluetooth.requestDevice({ filters: [{ name: 'GymCounter' }], optionalServices: [sUUID] });
                dev.addEventListener('gattserverdisconnected', onDisconnect);
                srv = await dev.gatt.connect();
                const svc = await srv.getPrimaryService(sUUID);
                chCmd = await svc.getCharacteristic(cCmd);
                const chData = await svc.getCharacteristic(cData);
                await chData.startNotifications();
                chData.addEventListener('characteristicvaluechanged', handleData);
                
                document.getElementById("status").innerText = "üü¢ Connected";
                document.getElementById("connectBox").style.display = "none";
                document.getElementById("mainPanel").style.display = "block";
                
                // Get Battery status immediately
                setTimeout(() => send('B'), 500);

            } catch (e) { alert("Connection error: " + e); }
        }

        function onDisconnect() {
            document.getElementById("status").innerText = "üî¥ Disconnected";
            document.getElementById("connectBox").style.display = "block";
            document.getElementById("mainPanel").style.display = "none";
        }

        async function send(cmd) { if(chCmd) await chCmd.writeValue(new TextEncoder().encode(cmd)); }

        async function loadCode() { 
            let c = document.getElementById("codeIn").value.trim().toUpperCase(); 
            if(c.length > 4) {
                await send("LOAD:"+c);
                alert("Code " + c + " loaded!");
            } else {
                alert("Invalid code format.");
            }
        }

        async function testSensor() {
            await send('C');
        }

        async function rebootDevice() {
            if(confirm("‚ö†Ô∏è Are you sure you want to REBOOT the device?\n\nThis will disconnect Bluetooth.")) {
                await send('R');
                alert("Device is rebooting... Please wait a few seconds and reconnect.");
            }
        }

        function handleData(e) {
            let v = new TextDecoder().decode(e.target.value);
            
            if (v.startsWith("CODE:")) { 
                let code = v.split(":")[1];
                document.getElementById("codeIn").value = code; 
                alert("‚úÖ New Code Created: " + code + "\n(Saved to input box)");
            }
            else if (v.includes("%") && !v.includes("BAT")) { 
                document.getElementById("liveData").innerText = v.split(":")[0];
            }
            else if (v.startsWith("BAT:")) {
                let volt = parseFloat(v.split(":")[1]); 
                let pct = Math.round(((volt - 3.3) / (4.2 - 3.3)) * 100);
                if (pct > 100) pct = 100; if (pct < 0) pct = 0;
                document.getElementById("batVal").innerText = "Bat: " + pct + "%";
            }
            else if (v.startsWith("REP:")) {
                let tbody = document.getElementById("histBody"); tbody.innerHTML = "";
                let parts = v.split(";");
                let reps = parts[1].split(",");
                reps.forEach((r,i) => {
                    if(r === "") return;
                    let valid = parseFloat(r) >= 70;
                    tbody.innerHTML += `<tr><td>${i+1}</td><td>${r}%</td><td class="${valid?'valid':'invalid'}">${valid?'OK':'NO REP'}</td></tr>`;
                });
            }
            else if (v === "ANG_START_OK") {
                console.log("Sensor OK");
            }
        }
    </script>
</body>
</html>
