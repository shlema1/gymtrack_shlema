<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gym Track</title>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background: #121212; color: #fff; text-align: center; padding: 20px; max-width: 600px; margin: auto; user-select: none; }
        h1 { color: #03dac6; margin-bottom: 5px; letter-spacing: 1px; font-weight: 300; text-transform: uppercase; }
        .box { background: #1e1e1e; border-radius: 12px; padding: 15px; margin-bottom: 15px; border: 1px solid #333; position: relative; box-shadow: 0 4px 6px rgba(0,0,0,0.3); }
        button { width: 100%; padding: 14px; margin: 6px 0; border: none; border-radius: 8px; font-size: 15px; font-weight: 600; cursor: pointer; color: white; transition: 0.2s; touch-action: manipulation; }
        button:active { transform: scale(0.98); opacity: 0.9; }
        .btn-blue { background: #2196F3; } 
        .btn-green { background: #00C853; } 
        .btn-red { background: #D32F2F; } 
        .btn-purple { background: #6200EE; }
        .btn-orange { background: #FF9800; color: #000; } /* TARE Button */
        .btn-danger-zone { background: #1a0000; color: #b71c1c; border: 1px solid #440000; font-size: 11px; padding: 10px; margin-top: 40px; }
        input { width: 80%; padding: 12px; border-radius: 6px; border: 1px solid #444; background: #2c2c2c; color: #fff; text-align: center; font-size: 18px; letter-spacing: 2px; font-family: monospace; outline: none; }
        input:focus { border-color: #03dac6; }
        #status { font-weight: bold; color: #666; margin-bottom: 20px; font-size: 13px; text-transform: uppercase; letter-spacing: 1px; }
        #liveData { font-size: 64px; font-weight: 700; color: #03dac6; margin: 10px 0; line-height: 1; }
        #batVal { position: absolute; top: 15px; right: 15px; color: #ffeb3b; font-size: 14px; font-weight: bold; }
        table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 14px; }
        td, th { border-bottom: 1px solid #333; padding: 12px 8px; text-align: left; }
        th { color: #888; font-size: 12px; text-transform: uppercase; }
        .valid { color: #00C853; font-weight: bold; } 
        .invalid { color: #D32F2F; }
        .tempo-text { font-size: 12px; color: #aaa; font-family: monospace; }
        .row { display: flex; gap: 10px; }
        .half { width: 50%; }
        hr { border: 0; border-top: 1px solid #333; margin: 15px 0; }
        .label { font-size: 11px; color: #888; margin-bottom: 5px; display: block; text-align: left; text-transform: uppercase; }
        .drift-val { font-size: 12px; color: #888; margin-top: 4px; font-family: monospace; }
        .drift-bad { color: #ff5252; font-weight: bold; }
    </style>
</head>
<body>

    <h1>Gym Track</h1>
    <div id="status">Disconnected</div>
    
    <div class="box" id="connectBox">
        <button onclick="connectBLE()" class="btn-blue">CONNECT DEVICE</button>
        <p style="font-size:12px; color:#555; margin-top:10px;">Ensure Bluetooth is ON</p>
    </div>

    <div id="mainPanel" style="display:none;">
        
        <div class="box">
            <div id="batVal">--%</div>
            <div style="font-size:12px; color:#aaa; margin-top:10px; letter-spacing: 1px;">CURRENT REPS</div>
            <div id="liveData">0</div>
            
            <div class="row">
                <button onclick="send('S')" class="btn-green half">‚ñ∂ START SET</button>
                <button onclick="send('E')" class="btn-red half">‚èπ FINISH</button>
            </div>
        </div>

        <div class="box">
            <h3 style="margin-top:0; font-size:16px; color:#ddd;">Setup</h3>
            
            <div style="background: #252525; padding: 10px; border-radius: 8px; margin-bottom: 15px;">
                <button onclick="send('T')" class="btn-orange" style="margin:0;">‚öñÔ∏è TARE (ZERO)</button>
                <div id="driftDisplay" class="drift-val">Drift: --</div>
            </div>

            <span class="label">Exercise Code</span>
            <input type="text" id="codeIn" placeholder="Axxxx / Lxxxx">
            <button onclick="loadCode()" class="btn-purple" style="margin-top:10px;">LOAD CODE</button>
            <hr>
            <span class="label">New Calibration</span>
            <div style="margin-bottom:15px;">
                <span class="label" style="color:#03dac6;">Angle Mode (Machines)</span>
                <div class="row">
                    <button onclick="send('C')" class="half" style="background:#333">1. Start (Rest)</button>
                    <button onclick="send('c')" class="half" style="background:#333">2. Stop (Peak)</button>
                </div>
            </div>
            <div>
                <span class="label" style="color:#03dac6;">Linear Mode (Cables)</span>
                <div class="row">
                    <button onclick="send('P')" class="half" style="background:#333">1. Start (Rest)</button>
                    <button onclick="send('p')" class="half" style="background:#333">2. Stop (Peak)</button>
                </div>
            </div>
        </div>

        <div class="box">
            <h3 style="margin-top:0; font-size:16px; color:#ddd;">History</h3>
            <table id="historyTable">
                <thead><tr><th>#</th><th>ROM</th><th>Away / Return</th><th>State</th></tr></thead>
                <tbody id="histBody"></tbody>
            </table>
        </div>

        <button onclick="rebootDevice()" class="btn-danger-zone">‚ö†Ô∏è REBOOT SYSTEM</button>
        <div style="height: 50px;"></div>
    </div>

    <script>
        const sUUID = "12345678-1234-1234-1234-123456789012";
        const cCmd = "87654321-4321-4321-4321-210987654321";
        const cData = "abcdef01-1234-5678-1234-56789abcdef0";
        
        let dev, srv, chCmd;
        let wakeLock = null;

        async function connectBLE() {
            try {
                dev = await navigator.bluetooth.requestDevice({ 
                    filters: [{ name: 'GymCounter' }], 
                    optionalServices: [sUUID] 
                });
                
                dev.addEventListener('gattserverdisconnected', onDisconnect);
                srv = await dev.gatt.connect();
                const svc = await srv.getPrimaryService(sUUID);
                chCmd = await svc.getCharacteristic(cCmd);
                const chData = await svc.getCharacteristic(cData);
                
                await chData.startNotifications();
                chData.addEventListener('characteristicvaluechanged', handleData);
                
                document.getElementById("status").innerText = "üü¢ CONNECTED";
                document.getElementById("connectBox").style.display = "none";
                document.getElementById("mainPanel").style.display = "block";
                
                setTimeout(() => send('B'), 500);
                if ('wakeLock' in navigator) { try { wakeLock = await navigator.wakeLock.request('screen'); } catch (err) {} }

            } catch (e) { alert("Connection failed: " + e); }
        }

        function onDisconnect() {
            document.getElementById("status").innerText = "üî¥ DISCONNECTED";
            document.getElementById("connectBox").style.display = "block";
            document.getElementById("mainPanel").style.display = "none";
            wakeLock = null;
        }

        async function send(cmd) { if(chCmd) await chCmd.writeValue(new TextEncoder().encode(cmd)); }

        function handleData(e) {
            let v = new TextDecoder().decode(e.target.value);
            
            if (v.startsWith("CODE:")) { 
                let code = v.split(":")[1];
                document.getElementById("codeIn").value = code; 
                alert("‚úÖ Calibration Saved!\nCode: " + code);
            }
            else if (v.includes("%") && !v.includes("BAT") && !v.includes("REP:")) { 
                let parts = v.split("%"); 
                let numPart = parts[0].split(":")[1]; 
                if(numPart) document.getElementById("liveData").innerText = numPart.trim() + "%";
            }
            else if (v.startsWith("BAT:")) {
                let pct = v.split(":")[1]; 
                document.getElementById("batVal").innerText = pct + "%";
            }
            // ZPRACOV√ÅN√ç DRIFTU (LIVE:2.5)
            else if (v.startsWith("LIVE:")) {
                let val = parseFloat(v.split(":")[1]);
                let el = document.getElementById("driftDisplay");
                el.innerText = "Drift: " + val.toFixed(1) + (document.getElementById("codeIn").value.startsWith("L") ? " Pa" : "¬∞");
                // Pokud je drift vƒõt≈°√≠ ne≈æ 5 stup≈à≈Ø (nebo 5 Pa), zƒçerven√°
                if(Math.abs(val) > 5.0) el.className = "drift-val drift-bad";
                else el.className = "drift-val";
            }
            else if (v === "TARE_OK") {
                // Kr√°tk√© bliknut√≠ pro potvrzen√≠
                let btn = document.querySelector(".btn-orange");
                let orig = btn.innerText;
                btn.innerText = "‚úÖ ZERO SET";
                setTimeout(() => btn.innerText = orig, 1000);
            }
            else if (v.startsWith("REP:")) {
                let tbody = document.getElementById("histBody"); tbody.innerHTML = "";
                let parts = v.split(";");
                let reps = parts[1].split(",");
                
                reps.forEach((r,i) => {
                    if(r === "") return;
                    let d = r.split("|"); 
                    let pct = d[0];
                    let t1 = d[1] ? d[1] : "-";
                    let t2 = d[2] ? d[2] : "-";
                    let valid = parseFloat(pct) >= 70;
                    
                    tbody.innerHTML += `
                    <tr>
                        <td>${i+1}</td>
                        <td style="font-weight:bold;">${pct}%</td>
                        <td class="tempo-text">${t1}s / ${t2}s</td>
                        <td class="${valid?'valid':'invalid'}">${valid?'OK':'NO'}</td>
                    </tr>`;
                });
            }
        }

        async function loadCode() { 
            let c = document.getElementById("codeIn").value.trim().toUpperCase(); 
            if(c.length > 4) { await send("LOAD:"+c); alert("Code " + c + " loaded!"); } 
            else alert("Invalid code (Format: Axxxx)");
        }

        async function rebootDevice() {
            if(confirm("‚ö†Ô∏è REBOOT DEVICE?")) { await send('R'); }
        }
    </script>
</body>
</html>
